import gradio as gr
import random
import json
from llama_cpp import Llama
from your_module import generate_screen_json  # ë„ˆê°€ ë³´ë‚¸ ëœë¤ ìƒì„± í•¨ìˆ˜
from your_config import GGUF_MODEL_PATH      # ëª¨ë¸ ê²½ë¡œ ì§€ì •

# llama ëª¨ë¸ ë¡œë“œ
llm = Llama(model_path=GGUF_MODEL_PATH, n_ctx=2048, n_threads=8)

# ë¯¸ë¦¬ ì •ì˜ëœ ìŠ¤í¬ë¦° ì˜ˆì œ
screens = [ ... ]  # ë„ˆê°€ ì¤€ screen ë¦¬ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ì‚¬ìš©

# llama ìš”ì•½ í˜¸ì¶œ í•¨ìˆ˜
def summarize(screen_json):
    prompt = f"ë‹¤ìŒ í™”ë©´ JSONì„ ìš”ì•½í•´ì¤˜ (í•œêµ­ì–´):\n{screen_json}"
    output = llm(prompt, max_tokens=256)
    return output["choices"][0]["text"].strip()

# ì„ íƒ ë¡œì§ í•¨ìˆ˜
def handle_input(mode, screen_index, custom_json, use_korean):
    if mode == "ì˜ˆì‹œì—ì„œ ì„ íƒ":
        return screens[screen_index]
    elif mode == "ì§ì ‘ ì…ë ¥":
        return custom_json
    elif mode == "ëœë¤ ìƒì„±":
        generated = generate_screen_json(use_korean)
        return json.dumps(generated, ensure_ascii=False, indent=2)
    else:
        return "ì•Œ ìˆ˜ ì—†ëŠ” ì…ë ¥ ë°©ì‹ì…ë‹ˆë‹¤."

# Gradio UI êµ¬ì„±
with gr.Blocks() as demo:
    gr.Markdown("## ğŸ§  í™”ë©´ JSON ìš”ì•½ê¸°")
    gr.Markdown("í™”ë©´ JSONì„ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•˜ì—¬ ìš”ì•½ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.")

    with gr.Row():
        mode = gr.Radio(["ì˜ˆì‹œì—ì„œ ì„ íƒ", "ì§ì ‘ ì…ë ¥", "ëœë¤ ìƒì„±"], label="ì…ë ¥ ë°©ì‹", value="ì§ì ‘ ì…ë ¥")
        screen_index = gr.Slider(minimum=0, maximum=len(screens) - 1, step=1, value=0, label="ì˜ˆì‹œ ì¸ë±ìŠ¤")
        use_korean = gr.Checkbox(label="í•œêµ­ì–´ ëœë¤ ìƒì„±", value=True)

    custom_json = gr.Textbox(label="ì§ì ‘ ì…ë ¥ JSON", lines=15, placeholder="ì—¬ê¸°ì— JSON ì…ë ¥")

    with gr.Row():
        generate_button = gr.Button("ğŸ“¥ ì¸í’‹ ìƒì„±í•˜ê¸°")
        input_json = gr.Textbox(label="ì‚¬ìš©ë  ì¸í’‹", lines=15)
    
    generate_button.click(
        fn=handle_input,
        inputs=[mode, screen_index, custom_json, use_korean],
        outputs=input_json
    )

    output_text = gr.Textbox(label="ğŸ“¤ ìš”ì•½ ê²°ê³¼", lines=15)
    summarize_button = gr.Button("ğŸ§  ìš”ì•½ ì‹¤í–‰")

    summarize_button.click(
        fn=summarize,
        inputs=input_json,
        outputs=output_text
    )

if __name__ == "__main__":
    demo.launch(server_name="0.0.0.0", server_port=7860, auth=("admin", "1234"))

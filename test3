import gradio as gr
import random
import json
from llama_cpp import Llama
import sys
import os

# --- ì„¤ì •ê°’ ë¶ˆëŸ¬ì˜¤ê¸° ---
sys.path.append(os.path.dirname(os.path.dirname(__file__)))
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), "..", "dataset")))
from config import save_dir_merged
from data_generator import generate_screen_json

GGUF_MODEL_PATH = os.path.join(save_dir_merged, "model.gguf")
MAX_TOKENS = 256

# llama ëª¨ë¸ ë¡œë“œ
llm = Llama(model_path=GGUF_MODEL_PATH, n_ctx=2048, n_threads=8)

# ë¯¸ë¦¬ ì •ì˜ëœ ìŠ¤í¬ë¦° ì˜ˆì œ

screens = [
    "{\n  \"hero:top\": \"btn:\\\"ê´‘ê³ |ë” ë³´ê¸°\\\"\",\n  \"list:mid\": [\n    \"\\\"TVING | í‹°ë¹™\\\"\",\n    \"[\\\"í™˜ìƒì ì¸ ì—¬ì •\\\"]: btn:\\\"ë…¸ ë¦¬ì‚¬ì´í´\\\",btn:\\\"ë¸Œë¡œë“œìºìŠ¤íŠ¸\\\",btn:\\\"í•˜ë¼í‚¤ë¦¬\\\",btn:\\\"ì•ˆë…•í•˜ì„¸ìš”\\\"\"\n  ],\n  \"tabs:mid\": [\n    \"\\\"ì¶”ì²œ\\\",\\\"ë¼ì´ë¸Œ\\\",\\\"ì•±ìŠ¤\\\"\"\n  ],\n  \"apps:btm\": \"\\\"SmartThings\\\",\\\"ì‚¼ì„± TV Plus\\\",\\\"Netflix\\\",\\\"Prime Video\\\",\\\"YouTube\\\",\\\"TVING | í‹°ë¹™\\\",\\\"ì™“ì±  | Watcha\\\",\\\"wavve\\\",\\\"Bixby\\\",\\\"Internet\\\",\\\"home_i_icon_app_edit.svg\\\"\",\n  \"list:btm\": [\n    \"\\\"TVING | í‹°ë¹™\\\"\"\n  ],\n  \"tb:left\": [\n    \"\\\"home_i_icon_mode_search.svg\\\",\\\"lifestyle_home_i_mode_art.svg\\\",\\\"home_i_icon_mode_lifeplus_normal.svg\\\",\\\"home_i_icon_mode_game_normal.svg\\\",\\\"home_i_icon_mode_home_selected.svg\\\",\\\"home_i_icon_system_settings.svg\\\",\\\"home_i_icon_system_privacy_24.svg\\\"\"\n  ]\n}",
    "{\n  \"list:top\": [\n    \"\\\"ê·¹ì„¸ í•„í„° ì²­ì†Œê°€ í•„ìš”í•©ë‹ˆë‹¤. í•„í„°ë¥¼ ì²­ì†Œí•˜ì—¬ ì•ˆì •ì ì¸ ì„±ëŠ¥ì„ ìœ ì§€í•´ ë³´ì„¸ìš”.\\\"\",\n    \"btn:\\\"ìì„¸íˆ ë³´ê¸°\\\",btn:\\\"ë‹«ê¸°\\\"\",\n    \"\\\"i_img_pagination_nf.json\\\",\\\"i_img_pagination_nf.json\\\",\\\"i_img_pagination_nf.json\\\"\",\n    \"\\\"ëŒ€ì‹œë³´ë“œ | ë§ˆì´ í™ˆ\\\"\",\n    \"\\\"cloudy?platform=summary\\\",\\\"73 Â°F\\\",\\\"1?platform=summary\\\",\\\"ì¢‹ìŒ\\\"\"\n  ],\n  \"list:mid\": [\n    \"btn:\\\"ë‚´ í° ìš¸ë¦¬ê¸°\\\"\",\n    \"btn:\\\"ì˜¤í”„ë¼ì¸|ê¸°ê¸° 2ê°œ\\\",btn:\\\"Home Care|ì•Œë¦¼ 2ê°œ\\\",btn:\\\"default?platform=summary|Energy|15.27 kWh\\\"\",\n    \"\\\"ì¦ê²¨ì°¾ê¸°\\\"\",\n    \"btn:\\\"ê±°ì‹¤|ê³µê¸°ì²­ì •ê¸°|ìë™í’\\\"\"\n  ],\n  \"list:btm\": [\n    \"btn:\\\"ì²´í—˜ì¡´|ì²´í—˜ì¡´ì—ì„œ SmartThings ì‚¬ìš© ë°©ë²•ì„ í™•ì¸í•´ ë³´ì„¸ìš”.|Addition\\\",btn:\\\"SmartThings í—ˆë¸Œ(ë§¤í„° ì§€ì›)|ë§¤í„° í‘œì¤€ì„ ì§€ì›í•˜ëŠ” SmartThings í—ˆë¸Œë¡œ í­ë„“ì€ IoT ê²½í—˜ì„ ì œê³µí•©ë‹ˆë‹¤.\\\"\",\n    \"btn:\\\"ë§µë·°|TVì˜ ëŒ€í™”ë©´ì—ì„œ ì§‘ì•ˆì˜ ê¸°ê¸°ì™€ ìœ ìš©í•œ ì •ë³´ë¥¼ í•œë²ˆì— í™•ì¸í•´ ë³´ì„¸ìš”\\\",btn:\\\"ë¹…ìŠ¤ë¹„ ìŒì„± ì œì–´|ì–¸ì œë“ ì§€ ë¹…ìŠ¤ë¹„ë¥¼ í†µí•´ ì§‘ì•ˆ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ê¸°ê¸°ë¥¼ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\\\"\"\n  ],\n  \"tb:left\": [\n    \"\\\"st_main_menulogo_close.svg\\\",\\\"st_main_menuicon_home_sel.svg\\\",\\\"st_main_menuicon_devices_n.svg\\\",\\\"st_main_menuicon_life_n.svg\\\",\\\"st_main_menuicon_routine_n.svg\\\",\\\"st_main_menuicon_adddevice_n.svg\\\",\\\"[homemenu]resize_profile_skjcwbfpdc.jpg\\\",\\\"st_main_menuicon_settings_n.svg\\\"\"\n  ]\n}",
    "{\n  \"list:top\": [\n    \"btn:\\\"í™˜ì˜í•©ë‹ˆë‹¤.|ë°”ë¡œ ì˜¤ëŠ˜! ì•„íŠ¸ ìŠ¤í† ì–´ë¥¼ ì²´í—˜í•´ë³´ì„¸ìš”.\\\"\"\n  ],\n  \"list:mid\": [\n    \"[\\\"ë‚´ ì•„íŠ¸ ìŠ¤í† ì–´\\\"]: \\\"ë‚˜ì˜ ì‚¬ì§„\\\",\\\"ì¦ê²¨ì°¾ê¸°\\\",\\\"ë©¤ë²„ì‹­\\\"\",\n    \"\\\"ìµœê·¼ ê°ìƒ\\\"\"\n  ],\n  \"list:btm\": [\n    \"btn:\\\"1521382429sam-s10002099_20250224052915.jpg\\\"\",\n    \"\\\"TextBox\\\"\",\n    \"\\\"TextBox\\\"\"\n  ],\n  \"tb:left\": [\n    \"\\\"home_i_icon_mode_search.svg\\\",\\\"home_i_icon_mode_art_selected.svg\\\",\\\"home_i_icon_mode_lifeplus_normal.svg\\\",\\\"home_i_icon_mode_game_normal.svg\\\",\\\"home_i_icon_mode_home_normal.svg\\\",\\\"home_i_icon_system_settings.svg\\\",\\\"home_i_icon_system_privacy_24.svg\\\"\"\n  ]\n}",
]

# llama ìš”ì•½ í˜¸ì¶œ í•¨ìˆ˜
def summarize(screen_json):
    prompt = f"ë‹¤ìŒ í™”ë©´ JSONì„ ìš”ì•½í•´ì¤˜ (í•œêµ­ì–´):\n{screen_json}"
    output = llm(prompt, max_tokens=MAX_TOKENS)
    return output["choices"][0]["text"].strip()

# ì¸í’‹ ìƒì„± ë¡œì§
def handle_input(mode, screen_index, use_korean):
    if mode == "ì˜ˆì‹œì—ì„œ ì„ íƒ":
        return screens[screen_index]
    elif mode == "ëœë¤ ìƒì„±":
        generated = generate_screen_json(use_korean)
        return json.dumps(generated, ensure_ascii=False, indent=2)
    else:
        return "ì…ë ¥ ë°©ì‹ì„ ì„ íƒí•´ ì£¼ì„¸ìš”."

# Gradio UI
with gr.Blocks() as demo:
    gr.Markdown("## ğŸ§  í™”ë©´ JSON ìš”ì•½ê¸°")
    gr.Markdown("í™”ë©´ JSONì„ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ í¸ì§‘í•˜ì—¬ ìš”ì•½ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.")

    with gr.Row():
        mode = gr.Radio(
            ["ëœë¤ ìƒì„±", "ì˜ˆì‹œì—ì„œ ì„ íƒ"],
            label="ì…ë ¥ ë°©ì‹",
            value="ëœë¤ ìƒì„±"
        )
        use_korean = gr.Checkbox(label="í•œêµ­ì–´ ëœë¤ ìƒì„±", value=True)

    screen_index = gr.Slider(
        minimum=0,
        maximum=len(screens) - 1,
        step=1,
        value=0,
        label="ì˜ˆì‹œ ì¸ë±ìŠ¤",
        visible=True
    )

    generate_button = gr.Button("ğŸ“¥ ì¸í’‹ ìƒì„±í•˜ê¸°")
    input_json = gr.Textbox(label="ğŸ“¥ ì‚¬ìš©ë  ì¸í’‹", lines=15)

    screen_index.change(
        fn=lambda i: screens[i],
        inputs=screen_index,
        outputs=input_json
    )

    generate_button.click(
        fn=handle_input,
        inputs=[mode, screen_index, use_korean],
        outputs=input_json
    )

    summarize_button = gr.Button("ğŸ§  ìš”ì•½ ì‹¤í–‰")
    output_text = gr.Textbox(label="ğŸ“¤ ìš”ì•½ ê²°ê³¼", lines=15)

    summarize_button.click(
        fn=summarize,
        inputs=input_json,
        outputs=output_text
    )

# ì„œë²„ ì‹¤í–‰
if __name__ == "__main__":
    demo.launch(server_name="0.0.0.0", server_port=7861, auth=("admin", "1234"))

import gradio as gr
import random
import json
from llama_cpp import Llama
import sys
import os

# --- 설정값 불러오기 ---
sys.path.append(os.path.dirname(os.path.dirname(__file__)))
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), "..", "dataset")))
from config import save_dir_merged
from data_generator import generate_screen_json

GGUF_MODEL_PATH = os.path.join(save_dir_merged, "model.gguf")
MAX_TOKENS = 256

# llama 모델 로드
llm = Llama(model_path=GGUF_MODEL_PATH, n_ctx=2048, n_threads=8)

# 미리 정의된 스크린 예제
screens = [ ... ]  # 생략된 기존 예시 JSON 리스트 그대로 사용

# llama 요약 호출 함수
def summarize(screen_json):
    prompt = f"다음 화면 JSON을 요약해줘 (한국어):\n{screen_json}"
    output = llm(prompt, max_tokens=256)
    return output["choices"][0]["text"].strip()

# 선택 로직 함수
def handle_input(mode, screen_index, custom_json, use_korean):
    if mode == "예시에서 선택":
        return screens[screen_index]
    elif mode == "직접 입력":
        return custom_json
    elif mode == "랜덤 생성":
        generated = generate_screen_json(use_korean)
        return json.dumps(generated, ensure_ascii=False, indent=2)
    else:
        return "알 수 없는 입력 방식입니다."

# Gradio UI 구성
with gr.Blocks() as demo:
    gr.Markdown("## 🧠 화면 JSON 요약기")
    gr.Markdown("화면 JSON을 선택하거나 입력하여 요약 결과를 확인하세요.")

    with gr.Row():
        mode = gr.Radio(
            ["직접 입력", "예시에서 선택", "랜덤 생성"],
            label="입력 방식",
            value="직접 입력"
        )
        use_korean = gr.Checkbox(label="한국어 랜덤 생성", value=True)

    screen_index = gr.Slider(
        minimum=0,
        maximum=len(screens) - 1,
        step=1,
        value=0,
        label="예시 인덱스",
        visible=False
    )

    custom_json = gr.Textbox(
        label="직접 입력 JSON",
        lines=15,
        placeholder="여기에 JSON 입력",
        visible=True
    )

    input_json = gr.Textbox(label="📥 사용될 인풋", lines=15)

    # input 생성 버튼 (랜덤/직접입력용)
    generate_button = gr.Button("📥 인풋 생성하기")

    # 요약 실행 버튼 (결과 위에 위치)
    summarize_button = gr.Button("🧠 요약 실행")

    output_text = gr.Textbox(label="📤 요약 결과", lines=15)

    # mode 변경에 따라 조건부 입력창 보이기
    def update_visibility(selected_mode):
        return {
            custom_json: gr.update(visible=selected_mode == "직접 입력"),
            screen_index: gr.update(visible=selected_mode == "예시에서 선택")
        }

    mode.change(
        update_visibility,
        inputs=mode,
        outputs=[custom_json, screen_index]
    )

    # 예시 인덱스 변경 시 input_json 자동 갱신
    screen_index.change(
        fn=lambda i: screens[i],
        inputs=screen_index,
        outputs=input_json
    )

    # generate 버튼 클릭 시
    generate_button.click(
        fn=handle_input,
        inputs=[mode, screen_index, custom_json, use_korean],
        outputs=input_json
    )

    # 요약 실행
    summarize_button.click(
        fn=summarize,
        inputs=input_json,
        outputs=output_text
    )

if __name__ == "__main__":
    demo.launch(server_name="0.0.0.0", server_port=7861, auth=("admin", "1234"))

import gradio as gr
import random
import json
from llama_cpp import Llama
from your_module import generate_screen_json  # 너가 보낸 랜덤 생성 함수
from your_config import GGUF_MODEL_PATH      # 모델 경로 지정

# llama 모델 로드
llm = Llama(model_path=GGUF_MODEL_PATH, n_ctx=2048, n_threads=8)

# 미리 정의된 스크린 예제
screens = [ ... ]  # 너가 준 screen 리스트 그대로 사용

# llama 요약 호출 함수
def summarize(screen_json):
    prompt = f"다음 화면 JSON을 요약해줘 (한국어):\n{screen_json}"
    output = llm(prompt, max_tokens=256)
    return output["choices"][0]["text"].strip()

# 선택 로직 함수
def handle_input(mode, screen_index, custom_json, use_korean):
    if mode == "예시에서 선택":
        return screens[screen_index]
    elif mode == "직접 입력":
        return custom_json
    elif mode == "랜덤 생성":
        generated = generate_screen_json(use_korean)
        return json.dumps(generated, ensure_ascii=False, indent=2)
    else:
        return "알 수 없는 입력 방식입니다."

# Gradio UI 구성
with gr.Blocks() as demo:
    gr.Markdown("## 🧠 화면 JSON 요약기")
    gr.Markdown("화면 JSON을 선택하거나 입력하여 요약 결과를 확인하세요.")

    with gr.Row():
        mode = gr.Radio(["예시에서 선택", "직접 입력", "랜덤 생성"], label="입력 방식", value="직접 입력")
        screen_index = gr.Slider(minimum=0, maximum=len(screens) - 1, step=1, value=0, label="예시 인덱스")
        use_korean = gr.Checkbox(label="한국어 랜덤 생성", value=True)

    custom_json = gr.Textbox(label="직접 입력 JSON", lines=15, placeholder="여기에 JSON 입력")

    with gr.Row():
        generate_button = gr.Button("📥 인풋 생성하기")
        input_json = gr.Textbox(label="사용될 인풋", lines=15)
    
    generate_button.click(
        fn=handle_input,
        inputs=[mode, screen_index, custom_json, use_korean],
        outputs=input_json
    )

    output_text = gr.Textbox(label="📤 요약 결과", lines=15)
    summarize_button = gr.Button("🧠 요약 실행")

    summarize_button.click(
        fn=summarize,
        inputs=input_json,
        outputs=output_text
    )

if __name__ == "__main__":
    demo.launch(server_name="0.0.0.0", server_port=7860, auth=("admin", "1234"))

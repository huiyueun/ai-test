import gradio as gr
import random
import json
from llama_cpp import Llama
import sys
import os

# --- ì„¤ì •ê°’ ë¶ˆëŸ¬ì˜¤ê¸° ---
sys.path.append(os.path.dirname(os.path.dirname(__file__)))
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), "..", "dataset")))
from config import save_dir_merged
from data_generator import generate_screen_json

GGUF_MODEL_PATH = os.path.join(save_dir_merged, "model.gguf")
MAX_TOKENS = 256

# llama ëª¨ë¸ ë¡œë“œ
llm = Llama(model_path=GGUF_MODEL_PATH, n_ctx=2048, n_threads=8)

# ë¯¸ë¦¬ ì •ì˜ëœ ìŠ¤í¬ë¦° ì˜ˆì œ
screens = [ ... ]  # ìƒëµëœ ê¸°ì¡´ ì˜ˆì‹œ JSON ë¦¬ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ì‚¬ìš©

# llama ìš”ì•½ í˜¸ì¶œ í•¨ìˆ˜
def summarize(screen_json):
    prompt = f"ë‹¤ìŒ í™”ë©´ JSONì„ ìš”ì•½í•´ì¤˜ (í•œêµ­ì–´):\n{screen_json}"
    output = llm(prompt, max_tokens=256)
    return output["choices"][0]["text"].strip()

# ì„ íƒ ë¡œì§ í•¨ìˆ˜
def handle_input(mode, screen_index, custom_json, use_korean):
    if mode == "ì˜ˆì‹œì—ì„œ ì„ íƒ":
        return screens[screen_index]
    elif mode == "ì§ì ‘ ì…ë ¥":
        return custom_json
    elif mode == "ëœë¤ ìƒì„±":
        generated = generate_screen_json(use_korean)
        return json.dumps(generated, ensure_ascii=False, indent=2)
    else:
        return "ì•Œ ìˆ˜ ì—†ëŠ” ì…ë ¥ ë°©ì‹ì…ë‹ˆë‹¤."

# Gradio UI êµ¬ì„±
with gr.Blocks() as demo:
    gr.Markdown("## ğŸ§  í™”ë©´ JSON ìš”ì•½ê¸°")
    gr.Markdown("í™”ë©´ JSONì„ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•˜ì—¬ ìš”ì•½ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.")

    with gr.Row():
        mode = gr.Radio(
            ["ì§ì ‘ ì…ë ¥", "ì˜ˆì‹œì—ì„œ ì„ íƒ", "ëœë¤ ìƒì„±"],
            label="ì…ë ¥ ë°©ì‹",
            value="ì§ì ‘ ì…ë ¥"
        )
        use_korean = gr.Checkbox(label="í•œêµ­ì–´ ëœë¤ ìƒì„±", value=True)

    screen_index = gr.Slider(
        minimum=0,
        maximum=len(screens) - 1,
        step=1,
        value=0,
        label="ì˜ˆì‹œ ì¸ë±ìŠ¤",
        visible=False
    )

    custom_json = gr.Textbox(
        label="ì§ì ‘ ì…ë ¥ JSON",
        lines=15,
        placeholder="ì—¬ê¸°ì— JSON ì…ë ¥",
        visible=True
    )

    input_json = gr.Textbox(label="ğŸ“¥ ì‚¬ìš©ë  ì¸í’‹", lines=15)

    # input ìƒì„± ë²„íŠ¼ (ëœë¤/ì§ì ‘ì…ë ¥ìš©)
    generate_button = gr.Button("ğŸ“¥ ì¸í’‹ ìƒì„±í•˜ê¸°")

    # ìš”ì•½ ì‹¤í–‰ ë²„íŠ¼ (ê²°ê³¼ ìœ„ì— ìœ„ì¹˜)
    summarize_button = gr.Button("ğŸ§  ìš”ì•½ ì‹¤í–‰")

    output_text = gr.Textbox(label="ğŸ“¤ ìš”ì•½ ê²°ê³¼", lines=15)

    # mode ë³€ê²½ì— ë”°ë¼ ì¡°ê±´ë¶€ ì…ë ¥ì°½ ë³´ì´ê¸°
    def update_visibility(selected_mode):
        return {
            custom_json: gr.update(visible=selected_mode == "ì§ì ‘ ì…ë ¥"),
            screen_index: gr.update(visible=selected_mode == "ì˜ˆì‹œì—ì„œ ì„ íƒ")
        }

    mode.change(
        update_visibility,
        inputs=mode,
        outputs=[custom_json, screen_index]
    )

    # ì˜ˆì‹œ ì¸ë±ìŠ¤ ë³€ê²½ ì‹œ input_json ìë™ ê°±ì‹ 
    screen_index.change(
        fn=lambda i: screens[i],
        inputs=screen_index,
        outputs=input_json
    )

    # generate ë²„íŠ¼ í´ë¦­ ì‹œ
    generate_button.click(
        fn=handle_input,
        inputs=[mode, screen_index, custom_json, use_korean],
        outputs=input_json
    )

    # ìš”ì•½ ì‹¤í–‰
    summarize_button.click(
        fn=summarize,
        inputs=input_json,
        outputs=output_text
    )

if __name__ == "__main__":
    demo.launch(server_name="0.0.0.0", server_port=7861, auth=("admin", "1234"))

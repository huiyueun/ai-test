import gradio as gr
import random
import json
from llama_cpp import Llama
import sys
import os

# --- ì„¤ì •ê°’ ë¶ˆëŸ¬ì˜¤ê¸° ---
sys.path.append(os.path.dirname(os.path.dirname(__file__)))
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), "..", "dataset")))
from config import save_dir_merged
from data_generator import generate_screen_json

GGUF_MODEL_PATH = os.path.join(save_dir_merged, "model.gguf")
MAX_TOKENS = 256

# llama ëª¨ë¸ ë¡œë“œ
llm = Llama(model_path=GGUF_MODEL_PATH, n_ctx=2048, n_threads=8)

# ë¯¸ë¦¬ ì •ì˜ëœ ìŠ¤í¬ë¦° ì˜ˆì œ
screens = [
    # ì‚¬ìš©ì ì œê³µí•œ JSON ì˜ˆì‹œ 3ê°œë¥¼ ì—¬ê¸°ì— ê·¸ëŒ€ë¡œ ì‚½ì…
    # ìƒëµ ê°€ëŠ¥ â€” ì‹¤ì œ ì‚¬ìš© ì‹œëŠ” ê·¸ëŒ€ë¡œ ë³µì‚¬
    # ì˜ˆì‹œ:
    """{
      "hero:top": "btn:\"ê´‘ê³ |ë” ë³´ê¸°\"",
      "list:mid": [
        "\"TVING | í‹°ë¹™\"",
        "[\"í™˜ìƒì ì¸ ì—¬ì •\"]: btn:\"ë…¸ ë¦¬ì‚¬ì´í´\",btn:\"ë¸Œë¡œë“œìºìŠ¤íŠ¸\",btn:\"í•˜ë¼í‚¤ë¦¬\",btn:\"ì•ˆë…•í•˜ì„¸ìš”\""
      ],
      "tabs:mid": [
        "\"ì¶”ì²œ\",\"ë¼ì´ë¸Œ\",\"ì•±ìŠ¤\""
      ],
      "apps:btm": "\"SmartThings\",\"ì‚¼ì„± TV Plus\",\"Netflix\",\"Prime Video\",\"YouTube\",\"TVING | í‹°ë¹™\",\"ì™“ì±  | Watcha\",\"wavve\",\"Bixby\",\"Internet\",\"home_i_icon_app_edit.svg\"",
      "list:btm": [
        "\"TVING | í‹°ë¹™\""
      ],
      "tb:left": [
        "\"home_i_icon_mode_search.svg\",\"lifestyle_home_i_mode_art.svg\",\"home_i_icon_mode_lifeplus_normal.svg\",\"home_i_icon_mode_game_normal.svg\",\"home_i_icon_mode_home_selected.svg\",\"home_i_icon_system_settings.svg\",\"home_i_icon_system_privacy_24.svg\""
      ]
    }""",
    # ë‚˜ë¨¸ì§€ 2ê°œë„ ê·¸ëŒ€ë¡œ ì´ì–´ ë¶™ì´ê¸°
]

# llama ìš”ì•½ í˜¸ì¶œ í•¨ìˆ˜
def summarize(screen_json):
    prompt = f"ë‹¤ìŒ í™”ë©´ JSONì„ ìš”ì•½í•´ì¤˜ (í•œêµ­ì–´):\n{screen_json}"
    output = llm(prompt, max_tokens=MAX_TOKENS)
    return output["choices"][0]["text"].strip()

# ì¸í’‹ ìƒì„± ë¡œì§
def handle_input(mode, screen_index, use_korean):
    if mode == "ì˜ˆì‹œì—ì„œ ì„ íƒ":
        return screens[screen_index]
    elif mode == "ëœë¤ ìƒì„±":
        generated = generate_screen_json(use_korean)
        return json.dumps(generated, ensure_ascii=False, indent=2)
    else:
        return "ì…ë ¥ ë°©ì‹ì„ ì„ íƒí•´ ì£¼ì„¸ìš”."

# Gradio UI
with gr.Blocks() as demo:
    gr.Markdown("## ğŸ§  í™”ë©´ JSON ìš”ì•½ê¸°")
    gr.Markdown("í™”ë©´ JSONì„ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ í¸ì§‘í•˜ì—¬ ìš”ì•½ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.")

    with gr.Row():
        mode = gr.Radio(
            ["ì˜ˆì‹œì—ì„œ ì„ íƒ", "ëœë¤ ìƒì„±"],
            label="ì…ë ¥ ë°©ì‹",
            value="ì˜ˆì‹œì—ì„œ ì„ íƒ"
        )
        use_korean = gr.Checkbox(label="í•œêµ­ì–´ ëœë¤ ìƒì„±", value=True)

    screen_index = gr.Slider(
        minimum=0,
        maximum=len(screens) - 1,
        step=1,
        value=0,
        label="ì˜ˆì‹œ ì¸ë±ìŠ¤",
        visible=True
    )

    input_json = gr.Textbox(label="ğŸ“¥ ì‚¬ìš©ë  ì¸í’‹", lines=15)

    screen_index.change(
        fn=lambda i: screens[i],
        inputs=screen_index,
        outputs=input_json
    )

    generate_button = gr.Button("ğŸ“¥ ì¸í’‹ ìƒì„±í•˜ê¸°")
    generate_button.click(
        fn=handle_input,
        inputs=[mode, screen_index, use_korean],
        outputs=input_json
    )

    summarize_button = gr.Button("ğŸ§  ìš”ì•½ ì‹¤í–‰")
    output_text = gr.Textbox(label="ğŸ“¤ ìš”ì•½ ê²°ê³¼", lines=15)

    summarize_button.click(
        fn=summarize,
        inputs=input_json,
        outputs=output_text
    )

# ì„œë²„ ì‹¤í–‰
if __name__ == "__main__":
    demo.launch(server_name="0.0.0.0", server_port=7861, auth=("admin", "1234"))
